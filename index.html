<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lá Mây - Hệ Thống Tích Điểm</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs (Compat version) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#ecfdf5',
                            100: '#d1fae5',
                            500: '#10b981',
                            600: '#059669', // Emerald 600
                            700: '#047857',
                            800: '#065f46',
                            900: '#064e3b',
                        }
                    },
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            font-family: 'Nunito', sans-serif; 
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            min-height: 100vh;
        }
        .logo-font { font-family: 'Playfair Display', serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
        }
        .animate-fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,env">
        const { useState, useEffect } = React;
        
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDLQBLROJ1ABogfjll-9ucznO3tchy-4aE",
            authDomain: "shop-tich-diem.firebaseapp.com",
            projectId: "shop-tich-diem",
            storageBucket: "shop-tich-diem.firebasestorage.app",
            messagingSenderId: "767439185361",
            appId: "1:767439185361:web:a33131993aa244f4cc2cf0",
            measurementId: "G-3JZ18BHBD5"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        // Using a new appId namespace to separate from old data if needed, or keep same to preserve users
        const appId = window.__app_id || 'lamay-loyalty-system'; 

        // Logo URL from user upload
        const LOGO_URL = "logolamay.png";

        // --- Helpers ---
        const getCollectionRef = (name) => {
            return db.collection('artifacts').doc(appId).collection('public').doc('data').collection(name);
        };
        const getUserRef = (phone) => {
            return getCollectionRef('users').doc(phone);
        };
        const getVoucherRef = (code) => {
            return getCollectionRef('vouchers').doc(code);
        };

        const generateCode = () => {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 4; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            return `LAMAY-${result}`;
        };

        // --- Components ---

        const Notification = ({ message, type, onClose }) => {
            if (!message) return null;
            const styles = type === 'success' 
                ? 'bg-emerald-100 text-emerald-800 border-emerald-200' 
                : 'bg-red-100 text-red-800 border-red-200';
            
            return (
                <div className={`fixed top-6 right-6 z-50 px-6 py-4 rounded-xl border shadow-xl flex items-center gap-3 animate-fade-in ${styles}`}>
                    <i className={`fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} text-xl`}></i>
                    <span className="font-medium">{message}</span>
                    <button onClick={onClose} className="ml-4 hover:opacity-60 transition"><i className="fas fa-times"></i></button>
                </div>
            );
        };

        const BrandLogo = ({ size = "md" }) => {
            const dims = size === "lg" ? "h-24" : size === "md" ? "h-12" : "h-8";
            return (
                <img src={LOGO_URL} alt="Lá Mây Logo" className={`${dims} object-contain drop-shadow-sm hover:scale-105 transition duration-300`} />
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('home'); 
            const [notification, setNotification] = useState({ msg: '', type: '' });
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (window.__initial_auth_token) {
                            await auth.signInWithCustomToken(window.__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (error) {
                        console.error("Auth error:", error);
                    }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const showNotify = (msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification({ msg: '', type: '' }), 4000);
            };

            if (loading) return (
                <div className="min-h-screen flex items-center justify-center bg-brand-50">
                    <div className="text-center animate-pulse">
                        <BrandLogo size="lg" />
                        <p className="mt-4 text-brand-800 font-medium">Đang tải dữ liệu...</p>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen text-gray-800 font-sans selection:bg-brand-200">
                    <Notification message={notification.msg} type={notification.type} onClose={() => setNotification({ msg: '', type: '' })} />
                    
                    <header className="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-40 border-b border-brand-100">
                        <div className="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('home')}>
                                <BrandLogo size="md" />
                            </div>
                            {view !== 'home' && (
                                <button onClick={() => setView('home')} className="px-4 py-2 rounded-full text-sm font-bold text-brand-700 bg-brand-50 hover:bg-brand-100 transition flex items-center gap-2">
                                    <i className="fas fa-home"></i> Trang chủ
                                </button>
                            )}
                        </div>
                    </header>

                    <main className="max-w-5xl mx-auto px-4 py-8">
                        {view === 'home' && <HomeView setView={setView} />}
                        {view === 'admin' && <AdminView user={user} showNotify={showNotify} />}
                        {view === 'customer' && <CustomerView user={user} showNotify={showNotify} />}
                    </main>

                    <footer className="text-center py-8 text-brand-800/60 text-sm">
                        <p>© 2024 Lá Mây - Natural & Organic.</p>
                        <p className="text-xs mt-1">Hệ thống tích điểm khách hàng thân thiết</p>
                    </footer>
                </div>
            );
        };

        const HomeView = ({ setView }) => (
            <div className="flex flex-col items-center justify-center py-10 gap-10 animate-fade-in">
                <div className="text-center max-w-2xl">
                    <h1 className="text-4xl md:text-5xl font-bold text-brand-900 mb-4 logo-font">Lá Mây</h1>
                    <p className="text-brand-700 text-lg">Chào mừng bạn đến với hệ thống tích điểm.</p>
                </div>
                
                <div className="grid md:grid-cols-2 gap-8 w-full max-w-3xl px-4">
                    <button 
                        onClick={() => setView('customer')}
                        className="glass-panel p-8 rounded-3xl hover:shadow-2xl transition-all hover:-translate-y-2 group cursor-pointer border-t-4 border-brand-500 text-center relative overflow-hidden"
                    >
                        <div className="absolute top-0 right-0 p-4 opacity-5 text-9xl text-brand-900 group-hover:scale-110 transition duration-700"><i className="fas fa-leaf"></i></div>
                        <div className="w-20 h-20 mx-auto bg-brand-100 rounded-full flex items-center justify-center text-brand-600 text-3xl mb-6 group-hover:bg-brand-600 group-hover:text-white transition-colors duration-300 shadow-inner">
                            <i className="fas fa-user"></i>
                        </div>
                        <h3 className="text-2xl font-bold text-brand-900 mb-2">Khách Hàng</h3>
                        <p className="text-gray-600 text-sm">Nhập mã thưởng, kiểm tra điểm và lịch sử giao dịch.</p>
                    </button>

                    <button 
                        onClick={() => setView('admin')}
                        className="glass-panel p-8 rounded-3xl hover:shadow-2xl transition-all hover:-translate-y-2 group cursor-pointer border-t-4 border-gray-500 text-center relative overflow-hidden"
                    >
                         <div className="absolute top-0 right-0 p-4 opacity-5 text-9xl text-gray-900 group-hover:scale-110 transition duration-700"><i className="fas fa-cogs"></i></div>
                        <div className="w-20 h-20 mx-auto bg-gray-100 rounded-full flex items-center justify-center text-gray-600 text-3xl mb-6 group-hover:bg-gray-700 group-hover:text-white transition-colors duration-300 shadow-inner">
                            <i className="fas fa-store"></i>
                        </div>
                        <h3 className="text-2xl font-bold text-gray-800 mb-2">Cửa Hàng (Admin)</h3>
                        <p className="text-gray-600 text-sm">Tạo mã thưởng cho đơn hàng online và quản lý.</p>
                    </button>
                </div>
            </div>
        );

        const AdminView = ({ user, showNotify }) => {
            const [activeTab, setActiveTab] = useState('create-code'); // Default tab
            const [pointValue, setPointValue] = useState('');
            const [generatedCode, setGeneratedCode] = useState('');
            const [usersList, setUsersList] = useState([]);
            const [pin, setPin] = useState('');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);

            // Fetch users list
            useEffect(() => {
                if (!isAuthenticated || activeTab !== 'list') return;
                const unsubscribe = getCollectionRef('users').orderBy('createdAt', 'desc').onSnapshot((snapshot) => {
                    const users = snapshot.docs.map(doc => doc.data());
                    setUsersList(users);
                });
                return () => unsubscribe();
            }, [activeTab, isAuthenticated]);

            const handleCreateCode = async (e) => {
                e.preventDefault();
                if (!pointValue || parseInt(pointValue) <= 0) return showNotify("Vui lòng nhập số điểm hợp lệ", "error");

                setIsSubmitting(true);
                try {
                    const newCode = generateCode();
                    const voucherData = {
                        code: newCode,
                        value: parseInt(pointValue),
                        status: 'active', // active, used
                        createdBy: 'admin',
                        createdAt: new Date().toISOString()
                    };

                    await getVoucherRef(newCode).set(voucherData);
                    setGeneratedCode(newCode);
                    showNotify("Tạo mã thành công!", "success");
                    setPointValue('');
                } catch (error) {
                    showNotify("Lỗi: " + error.message, "error");
                }
                setIsSubmitting(false);
            };

            if (!isAuthenticated) {
                return (
                    <div className="max-w-md mx-auto glass-panel p-10 rounded-3xl text-center animate-fade-in mt-10">
                        <div className="mb-6 text-brand-600 text-5xl"><i className="fas fa-shield-alt"></i></div>
                        <h3 className="text-2xl font-bold mb-2 text-brand-900">Quản trị viên</h3>
                        <p className="text-gray-500 mb-8">Vui lòng nhập mã PIN bảo mật</p>
                        <form onSubmit={(e) => {
                            e.preventDefault();
                            if (pin === '2209') setIsAuthenticated(true);
                            else showNotify('Mật khẩu không đúng', 'error');
                        }}>
                            <input 
                                type="password" 
                                className="w-full p-4 border border-brand-200 rounded-xl mb-6 text-center text-3xl tracking-[1em] outline-none focus:ring-2 focus:ring-brand-500 bg-white/50 font-bold text-brand-800"
                                maxLength="4"
                                value={pin}
                                onChange={(e) => setPin(e.target.value)}
                                placeholder="••••"
                                autoFocus
                            />
                            <button type="submit" className="w-full bg-brand-600 text-white py-4 rounded-xl font-bold hover:bg-brand-700 transition shadow-lg shadow-brand-200">
                                Đăng Nhập
                            </button>
                        </form>
                    </div>
                );
            }

            return (
                <div className="bg-white rounded-3xl shadow-xl overflow-hidden animate-fade-in min-h-[500px] border border-brand-100">
                    <div className="flex border-b border-gray-100">
                        <button 
                            onClick={() => setActiveTab('create-code')}
                            className={`flex-1 py-5 font-bold text-sm transition-colors ${activeTab === 'create-code' ? 'bg-brand-50 text-brand-700 border-b-2 border-brand-600' : 'text-gray-500 hover:bg-gray-50'}`}
                        >
                            <i className="fas fa-qrcode mr-2"></i>Tạo Mã Thưởng
                        </button>
                        <button 
                            onClick={() => setActiveTab('list')}
                            className={`flex-1 py-5 font-bold text-sm transition-colors ${activeTab === 'list' ? 'bg-brand-50 text-brand-700 border-b-2 border-brand-600' : 'text-gray-500 hover:bg-gray-50'}`}
                        >
                            <i className="fas fa-users mr-2"></i>Danh Sách Khách
                        </button>
                    </div>

                    <div className="p-8 bg-gray-50/50 h-full">
                        {activeTab === 'create-code' && (
                            <div className="max-w-lg mx-auto">
                                <div className="text-center mb-8">
                                    <h3 className="text-xl font-bold text-gray-800">Phát Hành Mã Điểm</h3>
                                    <p className="text-sm text-gray-500">Tạo mã để gửi cho khách hàng nhập (Online)</p>
                                </div>

                                <div className="bg-white p-8 rounded-2xl shadow-lg border-t-4 border-brand-500 animate-fade-in">
                                    <form onSubmit={handleCreateCode} className="space-y-6">
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-2">Giá trị điểm thưởng</label>
                                            <div className="relative">
                                                <input 
                                                    type="number" 
                                                    value={pointValue}
                                                    onChange={e => setPointValue(e.target.value)}
                                                    className="w-full p-4 pl-12 border rounded-xl focus:ring-2 focus:ring-brand-500 outline-none text-xl font-bold text-brand-700"
                                                    placeholder="VD: 50"
                                                    required
                                                />
                                                <div className="absolute left-4 top-4 text-brand-400 text-xl">
                                                    <i className="fas fa-star"></i>
                                                </div>
                                                <span className="absolute right-4 top-5 text-gray-400 text-sm font-bold">điểm</span>
                                            </div>
                                        </div>
                                        <button disabled={isSubmitting} type="submit" className="w-full bg-gradient-to-r from-brand-600 to-brand-500 text-white py-4 rounded-xl font-bold hover:shadow-lg transition transform hover:-translate-y-1">
                                            {isSubmitting ? 'Đang tạo...' : 'Tạo Mã Ngay'}
                                        </button>
                                    </form>

                                    {generatedCode && (
                                        <div className="mt-8 bg-brand-50 border border-brand-200 rounded-xl p-6 text-center animate-fade-in relative overflow-hidden">
                                            <div className="absolute top-0 left-0 w-full h-1 bg-brand-300"></div>
                                            <p className="text-brand-800 text-sm mb-3 font-medium uppercase tracking-wider">Mã thưởng vừa tạo</p>
                                            <div className="bg-white border-2 border-dashed border-brand-400 rounded-lg p-4 mb-4 cursor-pointer hover:bg-gray-50 transition group" onClick={() => {navigator.clipboard.writeText(generatedCode); showNotify('Đã sao chép mã!');}}>
                                                <span className="text-3xl font-black text-brand-700 tracking-wider font-mono select-all">{generatedCode}</span>
                                                <div className="text-xs text-gray-400 mt-1 group-hover:text-brand-500"><i className="fas fa-copy mr-1"></i> Chạm để sao chép</div>
                                            </div>
                                            <p className="text-xs text-gray-500">Hãy gửi mã này cho khách hàng (qua Chat, Email...).<br/>Khách sẽ tự nhập mã để nhận điểm.</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'list' && (
                            <div>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold text-brand-900">Danh sách thành viên ({usersList.length})</h3>
                                    <button className="text-sm text-brand-600 hover:underline"><i className="fas fa-file-export mr-1"></i> Xuất Excel</button>
                                </div>
                                <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                                    <table className="w-full text-left">
                                        <thead className="bg-gray-50 text-gray-500 text-xs uppercase font-bold tracking-wider">
                                            <tr>
                                                <th className="p-4">Khách hàng</th>
                                                <th className="p-4 text-right">Điểm tích lũy</th>
                                                <th className="p-4 text-right">Ngày tham gia</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {usersList.map((u) => (
                                                <tr key={u.phoneNumber} className="hover:bg-brand-50 transition-colors">
                                                    <td className="p-4">
                                                        <div className="font-bold text-gray-800">{u.name}</div>
                                                        <div className="text-gray-400 text-xs font-mono">{u.phoneNumber}</div>
                                                    </td>
                                                    <td className="p-4 text-right">
                                                        <span className="bg-brand-100 text-brand-800 px-3 py-1 rounded-full font-bold text-sm">{u.currentPoints}</span>
                                                    </td>
                                                    <td className="p-4 text-right text-gray-500 text-sm">
                                                        {u.createdAt ? new Date(u.createdAt).toLocaleDateString('vi-VN') : '-'}
                                                    </td>
                                                </tr>
                                            ))}
                                            {usersList.length === 0 && (
                                                <tr><td colSpan="3" className="p-8 text-center text-gray-400">Chưa có dữ liệu khách hàng</td></tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const CustomerView = ({ user, showNotify }) => {
            const [mode, setMode] = useState('login'); 
            const [phone, setPhone] = useState('');
            const [name, setName] = useState('');
            const [userData, setUserData] = useState(null);
            const [history, setHistory] = useState([]);
            const [voucherCode, setVoucherCode] = useState(''); // State for inputting code
            const [isProcessing, setIsProcessing] = useState(false);

            useEffect(() => {
                if (mode === 'dashboard' && userData) {
                    // Update user info live
                    const userUnsub = getUserRef(userData.phoneNumber).onSnapshot(doc => {
                        if(doc.exists) setUserData(doc.data());
                    });

                    // Update history live
                    const histUnsub = getCollectionRef('transactions')
                        .where('phoneNumber', '==', userData.phoneNumber)
                        .onSnapshot((snapshot) => {
                            const trans = [];
                            snapshot.forEach(doc => trans.push(doc.data()));
                            trans.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                            setHistory(trans);
                        });
                    return () => { userUnsub(); histUnsub(); }
                }
            }, [mode, userData?.phoneNumber]);

            const handleRegister = async (e) => {
                e.preventDefault();
                setIsProcessing(true);
                try {
                    const userRef = getUserRef(phone);
                    const docSnap = await userRef.get();
                    if (docSnap.exists) {
                        showNotify('Số điện thoại này đã đăng ký. Vui lòng đăng nhập.', 'error');
                        setMode('login');
                    } else {
                        const newUser = {
                            name: name,
                            phoneNumber: phone,
                            currentPoints: 0,
                            createdAt: new Date().toISOString()
                        };
                        await userRef.set(newUser);
                        showNotify('Đăng ký thành công!');
                        setUserData(newUser);
                        setMode('dashboard');
                    }
                } catch (err) {
                    showNotify('Lỗi: ' + err.message, 'error');
                }
                setIsProcessing(false);
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setIsProcessing(true);
                try {
                    const userRef = getUserRef(phone);
                    const docSnap = await userRef.get();
                    if (docSnap.exists) {
                        setUserData(docSnap.data());
                        setMode('dashboard');
                        showNotify('Xin chào ' + docSnap.data().name);
                    } else {
                        showNotify('Số điện thoại chưa đăng ký.', 'error');
                        setMode('register');
                    }
                } catch (err) {
                    showNotify('Lỗi: ' + err.message, 'error');
                }
                setIsProcessing(false);
            };

            const handleRedeemCode = async (e) => {
                e.preventDefault();
                if (!voucherCode) return;
                setIsProcessing(true);

                try {
                    const code = voucherCode.trim().toUpperCase();
                    const voucherRef = getVoucherRef(code);
                    const voucherSnap = await voucherRef.get();

                    if (!voucherSnap.exists) {
                        throw new Error("Mã không hợp lệ hoặc không tồn tại");
                    }

                    const voucherData = voucherSnap.data();
                    if (voucherData.status !== 'active') {
                        throw new Error("Mã này đã được sử dụng");
                    }

                    // Updates
                    const newPoints = (userData.currentPoints || 0) + voucherData.value;
                    
                    // 1. Mark used
                    await voucherRef.update({
                        status: 'used',
                        usedBy: userData.phoneNumber,
                        usedAt: new Date().toISOString()
                    });

                    // 2. Add points
                    await getUserRef(userData.phoneNumber).update({
                        currentPoints: newPoints
                    });

                    // 3. Log transaction
                    await getCollectionRef('transactions').add({
                        phoneNumber: userData.phoneNumber,
                        amount: voucherData.value,
                        type: 'earn_code',
                        note: 'Nhập mã thưởng',
                        rewardCode: code,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    setVoucherCode('');
                    showNotify(`Thành công! Cộng ${voucherData.value} điểm.`, 'success');

                } catch (error) {
                    showNotify(error.message, 'error');
                }
                setIsProcessing(false);
            };

            if (mode === 'login') {
                return (
                    <div className="max-w-md mx-auto glass-panel p-8 rounded-3xl animate-fade-in">
                        <div className="text-center mb-8">
                            <h3 className="text-2xl font-bold text-brand-900 mb-2 font-serif">Đăng Nhập</h3>
                            <p className="text-gray-500 text-sm">Nhập số điện thoại để xem thẻ thành viên</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-5">
                            <div className="relative">
                                <i className="fas fa-phone absolute left-4 top-4 text-gray-400"></i>
                                <input 
                                    type="tel" 
                                    value={phone}
                                    onChange={e => setPhone(e.target.value)}
                                    className="w-full p-3 pl-10 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none bg-white/70"
                                    placeholder="Số điện thoại của bạn"
                                    required
                                />
                            </div>
                            <button disabled={isProcessing} type="submit" className="w-full bg-brand-600 text-white py-3 rounded-xl font-bold hover:bg-brand-700 transition shadow-lg shadow-brand-200">
                                {isProcessing ? 'Đang kiểm tra...' : 'Tiếp Tục'}
                            </button>
                        </form>
                        <div className="mt-6 text-center border-t border-gray-200 pt-4">
                            <button onClick={() => setMode('register')} className="text-brand-600 font-bold hover:underline">Đăng ký thành viên mới</button>
                        </div>
                    </div>
                );
            }

            if (mode === 'register') {
                return (
                    <div className="max-w-md mx-auto glass-panel p-8 rounded-3xl animate-fade-in">
                        <div className="text-center mb-8">
                            <h3 className="text-2xl font-bold text-brand-900 mb-2 font-serif">Đăng Ký Mới</h3>
                            <p className="text-gray-500 text-sm">Trở thành thành viên của Lá Mây</p>
                        </div>
                        <form onSubmit={handleRegister} className="space-y-5">
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1 ml-1">Họ tên</label>
                                <input 
                                    type="text" 
                                    value={name}
                                    onChange={e => setName(e.target.value)}
                                    className="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none bg-white/70"
                                    placeholder="VD: Nguyễn Văn A"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1 ml-1">Số điện thoại</label>
                                <input 
                                    type="tel" 
                                    value={phone}
                                    onChange={e => setPhone(e.target.value)}
                                    className="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none bg-white/70"
                                    placeholder="0912..."
                                    required
                                />
                            </div>
                            <button disabled={isProcessing} type="submit" className="w-full bg-brand-600 text-white py-3 rounded-xl font-bold hover:bg-brand-700 transition shadow-lg shadow-brand-200">
                                {isProcessing ? 'Đang xử lý...' : 'Hoàn Tất'}
                            </button>
                        </form>
                        <div className="mt-6 text-center">
                            <button onClick={() => setMode('login')} className="text-gray-500 text-sm hover:text-gray-700">Quay lại đăng nhập</button>
                        </div>
                    </div>
                );
            }

            // Customer Dashboard
            return (
                <div className="max-w-lg mx-auto space-y-8 animate-fade-in">
                    {/* Membership Card */}
                    <div className="relative bg-gradient-to-br from-brand-800 to-brand-600 rounded-3xl p-8 text-white shadow-2xl overflow-hidden min-h-[220px] flex flex-col justify-between transform transition hover:scale-[1.02]">
                        {/* Decorative Circles */}
                        <div className="absolute -top-10 -right-10 w-40 h-40 bg-white opacity-10 rounded-full blur-2xl"></div>
                        <div className="absolute bottom-0 left-0 w-32 h-32 bg-brand-400 opacity-20 rounded-full blur-xl"></div>
                        
                        <div className="flex justify-between items-start relative z-10">
                            <div>
                                <h2 className="text-xl font-serif tracking-wide opacity-90">Lá Mây Member</h2>
                                <p className="text-brand-100 text-xs tracking-widest mt-1">LOYALTY CARD</p>
                            </div>
                            <i className="fas fa-leaf text-4xl opacity-20"></i>
                        </div>

                        <div className="relative z-10 mt-6">
                            <div className="flex items-end gap-3">
                                <h1 className="text-6xl font-bold">{userData.currentPoints}</h1>
                                <span className="text-xl font-medium mb-2 text-brand-200">điểm</span>
                            </div>
                        </div>

                        <div className="flex justify-between items-end relative z-10 mt-4">
                            <div>
                                <p className="text-brand-200 text-xs uppercase">Chủ thẻ</p>
                                <p className="font-bold text-lg tracking-wide">{userData.name}</p>
                            </div>
                            <div className="text-right">
                                <p className="text-brand-200 text-xs font-mono">{userData.phoneNumber}</p>
                            </div>
                        </div>
                    </div>

                    {/* REDEEM CODE SECTION (NEWLY ADDED) */}
                    <div className="bg-white p-6 rounded-3xl shadow-lg border border-brand-100 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-400 to-brand-600"></div>
                        <h3 className="text-lg font-bold text-brand-900 mb-4 flex items-center gap-2">
                            <i className="fas fa-gift text-brand-500"></i> Nhập Mã Thưởng
                        </h3>
                        <form onSubmit={handleRedeemCode} className="flex gap-2">
                            <input 
                                type="text" 
                                value={voucherCode}
                                onChange={e => setVoucherCode(e.target.value)}
                                className="flex-1 p-3 border border-brand-200 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none uppercase font-bold text-brand-800 placeholder-brand-300"
                                placeholder="VD: LAMAY-X1Y2"
                            />
                            <button disabled={isProcessing} type="submit" className="bg-brand-600 text-white px-6 rounded-xl font-bold hover:bg-brand-700 transition shadow-lg shadow-brand-200">
                                {isProcessing ? <i className="fas fa-spinner fa-spin"></i> : 'Nạp'}
                            </button>
                        </form>
                        <p className="text-xs text-gray-500 mt-2 ml-1">* Nhập mã in trên hóa đơn hoặc nhận được qua tin nhắn.</p>
                    </div>

                    {/* Transaction History */}
                    <div className="bg-white/80 backdrop-blur-md p-6 rounded-3xl shadow-sm border border-brand-50">
                        <h3 className="text-lg font-bold text-brand-900 mb-4 pb-2 border-b border-gray-100 flex items-center gap-2">
                            <i className="fas fa-history text-brand-500"></i> Lịch sử giao dịch
                        </h3>
                        <div className="space-y-4 max-h-[300px] overflow-y-auto pr-2">
                            {history.length > 0 ? history.map((t, idx) => (
                                <div key={idx} className="flex justify-between items-center p-4 bg-white rounded-2xl shadow-sm border border-gray-50 hover:bg-brand-50 transition">
                                    <div className="flex items-center gap-4">
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center ${t.type === 'use' ? 'bg-orange-100 text-orange-600' : 'bg-brand-100 text-brand-600'}`}>
                                            <i className={`fas ${t.type === 'use' ? 'fa-minus' : 'fa-plus'}`}></i>
                                        </div>
                                        <div>
                                            <p className="font-bold text-gray-800 text-sm">{t.note || (t.type === 'earn_direct' ? 'Tích điểm tại quầy' : 'Giao dịch')}</p>
                                            <p className="text-xs text-gray-400">
                                                {t.timestamp ? new Date(t.timestamp.seconds * 1000).toLocaleString('vi-VN') : 'Vừa xong'}
                                            </p>
                                        </div>
                                    </div>
                                    <div className={`font-bold text-lg ${t.type === 'use' ? 'text-orange-500' : 'text-brand-600'}`}>
                                        {t.type === 'use' ? '-' : '+'}{t.amount}
                                    </div>
                                </div>
                            )) : (
                                <div className="text-center py-10 text-gray-400">
                                    <i className="fas fa-leaf text-4xl mb-3 opacity-30"></i>
                                    <p className="text-sm">Bạn chưa có giao dịch nào.</p>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="text-center pb-4">
                        <button onClick={() => {setUserData(null); setMode('login');}} className="text-gray-400 text-sm hover:text-red-500 transition flex items-center justify-center gap-2 mx-auto">
                            <i className="fas fa-sign-out-alt"></i> Đăng xuất
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>